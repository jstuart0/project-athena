# Authentik OIDC Setup for Athena Admin

This document provides instructions for configuring Authentik as the OIDC identity provider for the Athena Admin interface.

## Prerequisites

- Access to Authentik admin interface at https://auth.xmojo.net/if/admin
- Athena Admin deployed at https://athena-admin.xmojo.net
- kubectl access to thor cluster

## Step 1: Create OAuth2/OIDC Provider in Authentik

1. **Access Authentik Admin Console:**
   - Navigate to https://auth.xmojo.net/if/admin
   - Log in with admin credentials

2. **Create a New Provider:**
   - Go to **Applications** → **Providers**
   - Click **Create** → Select **OAuth2/OpenID Provider**

3. **Configure Provider Settings:**
   ```
   Name: athena-admin
   Authorization flow: default-provider-authorization-implicit-consent
   Client type: Confidential
   Client ID: <auto-generated - copy this>
   Client Secret: <auto-generated - copy this>
   Redirect URIs: https://athena-admin.xmojo.net/auth/callback
   Signing Key: authentik Self-signed Certificate
   ```

4. **Advanced Settings:**
   ```
   Scopes: openid, profile, email
   Subject mode: Based on the User's UUID
   Include claims in id_token: Yes
   Token validity:
     - Access token: 600 (10 minutes)
     - Refresh token: 86400 (1 day)
   ```

5. **Save the Provider** and note the Client ID and Client Secret

## Step 2: Create Application in Authentik

1. **Create New Application:**
   - Go to **Applications** → **Applications**
   - Click **Create**

2. **Configure Application:**
   ```
   Name: Athena Admin
   Slug: athena-admin
   Provider: athena-admin (select the provider created above)
   Launch URL: https://athena-admin.xmojo.net
   Icon: (optional - upload Athena logo)
   ```

3. **Save the Application**

## Step 3: Assign User Access

1. **Create/Update User Groups:**
   - Go to **Directory** → **Groups**
   - Create or select groups that should have access
   - Example groups:
     - `athena-admin-owners` (full admin access)
     - `athena-admin-operators` (configuration management)
     - `athena-admin-viewers` (read-only access)

2. **Assign Application to Groups:**
   - Go to **Applications** → **Applications** → **Athena Admin**
   - Click **Bindings** tab
   - Add group bindings as needed
   - Or add individual user bindings

## Step 4: Update Kubernetes Secrets

With the Client ID and Client Secret from Step 1, update the Kubernetes secret:

```bash
# Switch to thor cluster
kubectl config use-context thor

# Update the OIDC secret with real credentials
kubectl -n athena-admin create secret generic athena-admin-oidc \
    --from-literal=OIDC_CLIENT_ID="<YOUR_CLIENT_ID>" \
    --from-literal=OIDC_CLIENT_SECRET="<YOUR_CLIENT_SECRET>" \
    --from-literal=OIDC_ISSUER="https://auth.xmojo.net/application/o/athena-admin/" \
    --from-literal=OIDC_REDIRECT_URI="https://athena-admin.xmojo.net/auth/callback" \
    --from-literal=OIDC_SCOPES="openid profile email" \
    --from-literal=FRONTEND_URL="https://athena-admin.xmojo.net" \
    --dry-run=client -o yaml | kubectl apply -f -
```

## Step 5: Restart Backend Pods

After updating the secret, restart the backend pods to load the new credentials:

```bash
kubectl -n athena-admin rollout restart deployment/athena-admin-backend
kubectl -n athena-admin rollout status deployment/athena-admin-backend
```

## Step 6: Test Authentication Flow

1. **Access the Admin Interface:**
   - Navigate to https://athena-admin.xmojo.net/auth/login
   - You should be redirected to Authentik login page

2. **Log In:**
   - Enter your Authentik credentials
   - Grant consent for the application (first time only)

3. **Verify Redirect:**
   - After successful authentication, you should be redirected back to https://athena-admin.xmojo.net
   - A JWT token should be passed in the URL query parameter: `?token=...`
   - The frontend should store this token and use it for API calls

4. **Test API Access:**
   ```bash
   # Get your JWT token from the browser URL or localStorage
   export TOKEN="<your_jwt_token>"

   # Test authenticated endpoint
   curl -H "Authorization: Bearer $TOKEN" \
        https://athena-admin.xmojo.net/auth/me

   # Should return your user info:
   # {
   #   "id": 1,
   #   "username": "your_username",
   #   "email": "your_email",
   #   "role": "viewer",
   #   ...
   # }
   ```

## User Role Mapping

The Athena Admin backend uses Role-Based Access Control (RBAC) with 4 roles:

| Role     | Permissions                                              |
|----------|----------------------------------------------------------|
| owner    | Full access: read, write, delete, manage users/secrets   |
| operator | Configuration management: read, write, view audit logs   |
| viewer   | Read-only access to all resources                        |
| support  | Read-only access + audit log viewing                     |

**Default Role:** New users are created with the `viewer` role.

**Upgrading User Roles:**
To change a user's role, update the database directly:

```bash
# Connect to PostgreSQL
kubectl -n athena-admin exec -it deployment/postgres -- psql -U psadmin -d athena_admin

# Update user role
UPDATE users SET role = 'owner' WHERE username = 'your_username';

# Verify
SELECT id, username, email, role, active FROM users;
```

## Troubleshooting

### Issue: "Could not validate credentials" error

**Cause:** OIDC_CLIENT_ID or OIDC_CLIENT_SECRET not configured correctly

**Solution:**
1. Verify the secret has the correct values:
   ```bash
   kubectl -n athena-admin get secret athena-admin-oidc -o yaml
   # Check that CLIENT_ID and CLIENT_SECRET are base64-encoded correctly
   ```
2. Restart the backend pods

### Issue: "Authentication failed" during callback

**Cause:** Redirect URI mismatch or invalid authorization code

**Solution:**
1. Verify the Redirect URI in Authentik matches exactly: `https://athena-admin.xmojo.net/auth/callback`
2. Check backend logs:
   ```bash
   kubectl -n athena-admin logs -f deployment/athena-admin-backend
   ```

### Issue: User created but has no access

**Cause:** Default role is `viewer` which has read-only permissions

**Solution:** Upgrade the user's role in the database (see User Role Mapping above)

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   Authentication Flow                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. User → https://athena-admin.xmojo.net/auth/login       │
│                                                             │
│  2. Backend → Redirect to Authentik with:                  │
│     - client_id                                             │
│     - redirect_uri                                          │
│     - scope (openid profile email)                         │
│                                                             │
│  3. Authentik → User enters credentials                    │
│                                                             │
│  4. Authentik → Redirect to /auth/callback with:           │
│     - authorization_code                                    │
│                                                             │
│  5. Backend → Exchange code for tokens from Authentik:     │
│     - access_token                                          │
│     - id_token                                              │
│                                                             │
│  6. Backend → Fetch userinfo from Authentik                │
│                                                             │
│  7. Backend → Create/update user in PostgreSQL             │
│                                                             │
│  8. Backend → Generate internal JWT token with:            │
│     - user_id                                               │
│     - username                                              │
│     - role                                                  │
│                                                             │
│  9. Backend → Redirect to frontend with JWT token          │
│                                                             │
│ 10. Frontend → Store token, use for subsequent API calls   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Database Schema

The authentication system uses the following database table:

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    authentik_id VARCHAR(255) UNIQUE NOT NULL,  -- Authentik user UUID
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    role VARCHAR(32) NOT NULL DEFAULT 'viewer',
    active BOOLEAN NOT NULL DEFAULT true,
    last_login TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

## Security Considerations

1. **Secrets Management:**
   - OIDC credentials stored in Kubernetes secrets
   - JWT signing key stored separately in `athena-admin-secrets`
   - Never commit credentials to git

2. **Token Expiration:**
   - JWT tokens expire after 1 hour (configurable via JWT_EXPIRATION_SECONDS)
   - Users must re-authenticate after expiration
   - Consider implementing refresh token rotation

3. **Session Management:**
   - Sessions stored in Redis
   - Session secret stored in Kubernetes secret
   - Sessions cleared on logout

4. **HTTPS Only:**
   - All authentication flows require HTTPS
   - Redirect URIs must use HTTPS
   - Cookies set with Secure flag

## Next Steps

After authentication is working:

1. **Implement Policy Management API** (Phase 2)
2. **Add frontend authentication UI** (login button, user dropdown)
3. **Implement role-based UI controls** (hide/show features based on role)
4. **Add audit logging for authentication events**
5. **Set up monitoring for failed login attempts**

## Support

For issues or questions:
- Check backend logs: `kubectl -n athena-admin logs -f deployment/athena-admin-backend`
- Check Authentik logs in Authentik admin interface
- Review this document's Troubleshooting section
