version: '3.8'

# Project Athena - Mac mini Services
# Deployment: Qdrant (vector database) + Redis (cache)
#
# Deploy on Mac mini @ 192.168.10.29:
#   cd ~/athena/mac-mini
#   docker compose up -d
#
# Verify:
#   curl http://localhost:6333/healthz
#   redis-cli PING

services:
  # ==========================================================================
  # Qdrant Vector Database
  # ==========================================================================
  # Purpose: Store and retrieve knowledge embeddings
  # Dimensions: 384 (sentence-transformers/all-MiniLM-L6-v2)
  # Distance: Cosine similarity
  # Collections: athena_knowledge
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC (optional, for high-performance clients)
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      # Qdrant configuration
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - athena

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  # Purpose: Cache RAG responses, session data, and job queue
  # Max Memory: 2GB with LRU eviction
  # Persistence: AOF (append-only file) for durability
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - athena

# ==========================================================================
# Volumes
# ==========================================================================
# Persistent storage for Qdrant and Redis data
volumes:
  qdrant_storage:
    driver: local
  redis_data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================
# Internal network for service communication
networks:
  athena:
    driver: bridge
